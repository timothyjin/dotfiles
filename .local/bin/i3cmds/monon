#!/bin/sh

# Script to activate an external monitor with bumblebee and intel-virtual-output.
# To use a specific layout, edit the `~/.local/bin/layout-on` script.

usage() {
    echo "Usage: $(basename $0) [-h] [ -o OUTPUT ] [ -r RATE ]"
}

internal=$INTERNAL
external=$EXTERNAL

while [ "$1" != "" ]; do
    case $1 in
        -o | --output ) shift
                        external=$1
                        ;;
        -r | --rate )   shift
                        rate=$1
                        ;;
        -h | --help )   usage
                        exit
                        ;;
        * )             usage
                        exit 1
    esac
    shift
done

print() {
    echo "$1"
    notify-send "$(basename $0)" "$1"
}

# Exit if external display is already on
current=$(current-display)
[ "$current" != "$internal" ] && print "$internal is not the current primary display, run 'monoff' before running this script" && exit 1

# Prevent running this script as root, as it leads to bad window alignment on the external display
[ "$(whoami)" = "root" ] && echo "Do not run this script as root! Exiting..." && exit 2

# Add the bbswitch kernel module so we can turn on the card
modprobe bbswitch

# Start X server on the nvidia card and start intel-virtual-output
print "Starting Nvidia X server..."
optirun intel-virtual-output

# Turn on the external display
# When starting X server for the first time, all virtual outputs will be disconnected and so modes will not be available until connecting first
xrandr --output "$external" --primary --auto

# Run script to set configured on-layout
layout-on

# Set peripheral properties on both X servers
if [ -f ~/.xprofile ]
then
    . ~/.xprofile &
    DISPLAY=:8 . ~/.xprofile &
fi

# Restart some display applications
launch-redshift &
launch-comp &
# launch-polybar &
[ -n "$I3SOCK" ] && i3-msg restart

print "Now using displays:\n$( current-display | paste -sd',' )"
