#!/bin/sh

# Script to turn off a connected external monitor using bumblebee and intel-virtual-output.

internal="eDP1"
external="$(xrandr | grep "primary" | awk '{print $1}')"

print() {
    echo "$1"
    notify-send "$(basename $0):" "$1"
}

xrandr | grep "$internal" | grep -q "primary" && print "$internal is the current primary display, use 'monon' before running this script" && exit 1

# Turn on the laptop screen and turn off the external (virtual) screen
xrandr --output "$internal" --primary --auto --output "$external" --off

# Kill X server running on the nvidia card and wait for it to die
sudo kill $(ps ax | grep Xorg | grep :8 | awk '{print $1}')
print "Waiting for Nvidia X server to die..."
sleep 3

# Remove the nvidia kernel module so we can shut down the card
rmmod nvidia

# Turn off the nvidia card
echo OFF | sudo tee /proc/acpi/bbswitch

# Restart i3 on the laptop display
i3-msg restart

print "Display switched to $internal"
